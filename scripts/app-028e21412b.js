/******/!function(t){function e(n){if(o[n])return o[n].exports;var i=o[n]={exports:{},id:n,loaded:!1};return t[n].call(i.exports,i,i.exports,e),i.loaded=!0,i.exports}// webpackBootstrap
/******/
var o={};return e.m=t,e.c=o,e.p="",e(0)}([function(t,e,o){"use strict";var n=o(1),i=o(2),r=o(3),a=o(4),s=o(5),l=o(6),c=o(7),d=o(8),u=o(9),h=o(10);angular.module("intSmaBarcasDashboard",["ngAnimate","ngCookies","ngTouch","ngSanitize","ngMessages","ngAria","ngRoute","ngMaterial","angular-storage","angular-loading-bar"]).constant("Paho",Paho).constant("moment",moment).config(n.config).config(i.routerConfig).run(r.runBlock).filter("momentFormat",u.momentFormat).service("authenticationService",l.AuthenticationService).service("mqttClientService",c.MqttClientService).service("apiClientService",d.ApiClientService).controller("LoginController",a.LoginController).controller("DashboardController",s.DashboardController).directive("momentFrom",h.MomentFromDirective)},function(t,e){"use strict";function o(t,e,o){"ngInject";t.debugEnabled(!0),e.theme("default").primaryPalette("blue").accentPalette("blue-grey"),o.includeSpinner=!1}o.$inject=["$logProvider","$mdThemingProvider","cfpLoadingBarProvider"],Object.defineProperty(e,"__esModule",{value:!0}),e.config=o},function(t,e){"use strict";function o(t){"ngInject";t.when("/",{templateUrl:"app/login/login.html",controller:"LoginController",controllerAs:"loginCtrl"}).when("/dashboard",{templateUrl:"app/dashboard/dashboard.html",controller:"DashboardController",controllerAs:"dashboardCtrl"}).otherwise({redirectTo:"/"})}o.$inject=["$routeProvider"],Object.defineProperty(e,"__esModule",{value:!0}),e.routerConfig=o},function(t,e){"use strict";function o(t,e,o,i,r,a,s,l){"ngInject";if(t.globals=e.getObject("globals")||{},t.globals.currentUser){var c=t.globals.currentUser.token,d=l.parseJwt(c);n(d.exp)?(l.clearToken(),l.refreshToken(c)):o.defaults.headers.common.Authorization="JWT "+c}var u=t.$on("$locationChangeStart",function(){var e=["/"],o=-1==e.indexOf(r.path()),n=t.globals.currentUser;o&&!n?r.path("/"):"/"==r.path()&&n&&r.path("/dashboard")});t.$on("$destroy",u),s.locale("pt-br"),a.debug("runBlock end")}o.$inject=["$rootScope","$cookies","$http","$window","$location","$log","moment","authenticationService"],Object.defineProperty(e,"__esModule",{value:!0}),e.runBlock=o;var n=function(t){return Math.round((new Date).getTime()/1e3)>t}},function(t,e){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,o,n){return o&&t(e.prototype,o),n&&t(e,n),e}}();e.LoginController=function(){function t(e,n,i,r,a,s){"ngInject";o(this,t),this.$http=e,this.$log=n,this.$rootScope=i,this.$location=r,this.$mdToast=a,this.authenticationService=s,this.username="",this.password="",i.globals.currentUser&&this.$location.path("/dashboard")}return t.$inject=["$http","$log","$rootScope","$location","$mdToast","authenticationService"],n(t,[{key:"login",value:function(){var t=this;this.username&&this.password&&this.authenticationService.login(this.username,this.password).then(function(){t.$rootScope.globals.currentUser?(t.$mdToast.show(t.$mdToast.simple().textContent("Usuário conectado com sucesso.").position("top right").hideDelay(3e3)),t.$location.path("/dashboard")):t.$mdToast.show(t.$mdToast.simple().textContent("Usuário e senha informados não foram reconhecidos.").position("top right").hideDelay(3e3))})}}]),t}()},function(t,e){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,o,n){return o&&t(e.prototype,o),n&&t(e,n),e}}();e.DashboardController=function(){function t(e,n,i,r,a,s,l,c,d,u,h,m,p){"ngInject";var f=this;o(this,t),this.$location=i,this.$mdToast=a,this.$log=r,this.moment=s,this.Paho=l,this.store=c,this.authenticationService=h,this.apiClientService=m,this.mqttClientService=p,this.$timeout=d,this.$interval=u,this.lastUpdated=c.get("lastUpdated")||s(),this.user=e.globals.currentUser,this.blocks=[{title:"Bloco 10",loading:!0},{title:"Bloco 11",loading:!0},{title:"Bloco 12",loading:!0},{title:"Bloco 13",loading:!0}],this.cistern=c.get("cistern")||{title:"Cisterna",lowerLevel:!0,upperLevel:!1,lastUpdated:s()},this.dryWell=c.get("dryWell")||{title:"Poço Seco",level:!1,lastUpdated:s()},this.remoteControlTimeout=[],this.remoteControlWaiting=[],this.blockWaterInterval=[],this.client=new l.MQTT.Client(p.server,p.port,p.clientId),this.client.onConnectionLost=this.onConnectionLost.bind(this),this.client.onMessageArrived=this.onMessageArrived.bind(this),this.initialize(),n.$on("$destroy",function(){f.blockWaterInterval.forEach(function(t){f.$interval.cancel(t)})})}return t.$inject=["$rootScope","$scope","$location","$log","$mdToast","moment","Paho","store","$timeout","$interval","authenticationService","apiClientService","mqttClientService"],n(t,[{key:"initialize",value:function(){this.getLastInformation(),this.getLastInformationLater()}},{key:"getLastInformation",value:function(){var t=this;this.apiClientService.getLastInformation().then(function(e){var o=e.reduce(function(e,o){var n=o.results[0].registered_on;return e?t.moment(e).isBefore(n)?n:e:n});t.lastUpdated=t.moment(o),t.store.set("lastUpdated",t.lastUpdated),e.sort(function(t,e){return t.position-e.position});for(var n=0;n<t.blocks.length;n++)e[n].results[0].data>0?(t.blocks[n].needWaterSince=t.moment(e[n].results[0].registered_on),t.blocks[n].lastUpdated=t.moment(e[n].results[1].registered_on),t.blocks[n].percent=20):(t.blocks[n].lastUpdated=t.moment(e[n].results[0].registered_on),t.blocks[n].needWaterSince=t.moment(e[n].results[1].registered_on),t.blocks[n].percent=75),t.blocks[n].needWater=e[n].results[0].data>0,t.blocks[n].remoteControl=e[n+8].results[0].data>0,t.blocks[n].inProgress=e[n+8].results[0].data>0,0==n&&(t.blocks[n].inProgress=e[7].results[0].data>0),t.blocks[n].loading=!1;t.cistern.lowerLevel=e[4].results[0].data>0,t.cistern.upperLevel=e[5].results[0].data>0,t.cistern.lastUpdated=t.moment(e[5].results[0].registered_on),t.dryWell.level=e[6].results[0].data>0,t.dryWell.lastUpdated=t.moment(e[6].results[0].registered_on),t.handleBlockWater(),t.handleBlockWaterLater()})}},{key:"getLastInformationLater",value:function(){var t=this;this.$timeout(function(){t.getLastInformation(),t.getLastInformationLater()},5e3)}},{key:"reconnect",value:function(){this.client.connect({userName:this.mqttClientService.username,password:this.mqttClientService.password,onSuccess:this.onConnect.bind(this),onFailure:this.reconnectLater.bind(this)})}},{key:"reconnectLater",value:function(){var t=this;this.reconnectAttemptTimeout&&this.$timeout.cancel(this.reconnectAttemptTimeout),this.reconnectAttemptTimeout=this.$timeout(function(){t.reconnect()},5e3)}},{key:"onConnect",value:function(){this.client.subscribe(this.mqttClientService.topic)}},{key:"onConnectionLost",value:function(t){0!==t.errorCode&&this.reconnectLater()}},{key:"onMessageArrived",value:function(t){if(this.lastUpdated=this.moment(),this.store.set("lastUpdated",this.lastUpdated),t.destinationName==this.mqttClientService.topic&&this.lastMessage!=t.payloadString){for(var e=t.payloadString.split(",").map(function(t){return parseFloat(t)}),o=0;o<this.blocks.length;o++)this.blocks[o].loading||this.updateInfo(o,e);(this.cistern.lowerLevel!=e[4]>0||this.cistern.upperLevel!=e[5]>0)&&(this.cistern.lowerLevel=e[4]>0,this.cistern.upperLevel=e[5]>0,this.cistern.lastUpdated=this.lastUpdated),this.dryWell.level!=e[6]>0&&(this.dryWell.level=e[6]>0,this.dryWell.lastUpdated=this.lastUpdated),this.lastMessage=t.payloadString}this.store.set("cistern",this.cistern),this.store.set("dryWell",this.dryWell)}},{key:"updateInfo",value:function(t,e){e[t]&&!this.blocks[t].needWater?this.blocks[t].needWaterSince=this.moment():!e[t]&&this.blocks[t].needWater&&(this.blocks[t].lastUpdated=this.moment(),this.handleBlockWaterUpTo(t)),this.blocks[t].needWater=e[t]>0,this.blocks[t].remoteControl=e[t+8]>0,this.blocks[t].inProgress=e[t+8]>0,0==t&&(this.blocks[t].inProgress=e[7]>0)}},{key:"controlBlock",value:function(t){var e=this;this.remoteControlTimeout[t]&&this.$timeout.cancel(this.remoteControlTimeout[t]),this.remoteControlWaiting[t]=!0,this.remoteControlTimeout[t]=this.$timeout(function(){var o=new e.Paho.MQTT.Message(e.blocks[t].remoteControl?"0":"1");o.destinationName=e.mqttClientService.topic+"/"+t,e.client.send(o),e.$mdToast.show(e.$mdToast.simple().textContent("Comando para "+(e.blocks[t].remoteControl?"suspender":"abastecer")+" o "+e.blocks[t].title+" enviado.").position("top right").hideDelay(3e3)),e.remoteControlWaiting[t]=!1},1e3)}},{key:"handleBlockWater",value:function(){for(var t=0;t<this.blocks.length;t++)this.blocks[t].inProgress&&this.user.is_staff?(this.blocks[t].percent+=.3,this.blocks[t].percent>80&&(this.blocks[t].percent=80)):this.blocks[t].needWater?(this.blocks[t].percent=20-(this.moment().unix()-this.blocks[t].needWaterSince.unix())/750,this.blocks[t].percent<0&&(this.blocks[t].percent=3)):this.blocks[t].onInterval||(this.blocks[t].percent=80-(this.moment().unix()-this.blocks[t].lastUpdated.unix())/750,this.blocks[t].percent<20&&(this.blocks[t].percent=20))}},{key:"handleBlockWaterUpTo",value:function(t,e){var o=this,n=e||80;angular.isDefined(this.blockWaterInterval[t])&&(this.$interval.cancel(this.blockWaterInterval[t]),this.blockWaterInterval[t]=void 0),this.blockWaterInterval[t]=this.$interval(function(){o.blocks[t].onInterval=!0,o.blocks[t].percent++,o.blocks[t].percent>=n&&(o.blocks[t].percent=n,o.$interval.cancel(o.blockWaterInterval[t]),o.blocks[t].onInterval=!1)},50)}},{key:"handleBlockWaterLater",value:function(){var t=this;angular.isDefined(this.blockWaterTimeout)&&(this.$timeout.cancel(this.blockWaterTimeout),this.blockWaterTimeout=void 0),this.blockWaterTimeout=this.$timeout(function(){t.handleBlockWater(),t.handleBlockWaterLater()},5e3)}},{key:"logout",value:function(){this.authenticationService.clearToken(),this.$mdToast.show(this.$mdToast.simple().textContent("Usuário desconectado.").position("top right").hideDelay(3e3)),this.$location.path("/")}}]),t}()},function(t,e){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,o,n){return o&&t(e.prototype,o),n&&t(e,n),e}}();e.AuthenticationService=function(){function t(e,n,i,r,a){"ngInject";o(this,t),this.$http=e,this.$log=n,this.$window=i,this.$cookies=r,this.$rootScope=a,this.apiHost="https://api.integrada.ind.br/api/v1"}return t.$inject=["$http","$log","$window","$cookies","$rootScope"],n(t,[{key:"login",value:function(t,e){var o=this;return this.clearToken(),this.$http.post(this.apiHost+"/auth/token/",{username:t,password:e}).then(function(t){return o.setToken(t.data.token),t.data})["catch"](function(t){return o.$log.error("XHR Failed for login.\n"+angular.toJson(t.data,!0)),t})}},{key:"setToken",value:function(t){var e=this.parseJwt(t);this.$rootScope.globals={currentUser:{username:e.username,is_staff:e.is_staff,token:t}},this.$http.defaults.headers.common.Authorization="JWT "+t,this.$cookies.putObject("globals",this.$rootScope.globals)}},{key:"refreshToken",value:function(t){var e=this;this.$http.post(this.apiHost+"/auth/token/refresh/",{token:t}).then(function(t){e.setToken(t.data.token)})}},{key:"clearToken",value:function(){this.$rootScope.globals={},this.$http.defaults.headers.common.Authorization="",this.$cookies.remove("globals")}},{key:"parseJwt",value:function(t){var e=t.split(".")[1],o=e.replace("-","+").replace("_","/");return angular.fromJson(this.$window.atob(o))}}]),t}()},function(t,e){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});e.MqttClientService=["moment",function n(t){"ngInject";o(this,n),this.server="iot.eclipse.org",this.port=80,this.clientId="barcas_"+t().unix(),this.topic="sma/b7z8cpel",this.username="barcas",this.password="123mudar"}]},function(t,e){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,o,n){return o&&t(e.prototype,o),n&&t(e,n),e}}();e.ApiClientService=function(){function t(e,n,i,r){"ngInject";o(this,t),this.$q=i,this.$http=e,this.$log=n,this.store=r,this.apiHost="https://api.integrada.ind.br/api/v1",this.limit=12,this.hub=1}return t.$inject=["$http","$log","$q","store"],n(t,[{key:"getLastInformationPosition",value:function(t){return this.$http.get(this.apiHost+"/hubs/"+this.hub+"/labels/"+t+"/data/?limit=2").then(function(e){return{position:t,results:e.data.results}})}},{key:"getLastInformation",value:function(){for(var t=this,e=[],o=0;o<this.limit;o++)e[o]=this.getLastInformationPosition(o+1);return this.$q.all(e).then(function(t){return t})["catch"](function(e){return t.$log.error("XHR Failed for getLastInformation.\n"+angular.toJson(e.data,!0)),e})}}]),t}()},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.momentFormat=function(){return function(t,e){return t=t||moment(),e=e||"LLL",moment(t).format(e)}}},function(t,e){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(){"ngInject";var t={restrict:"E",templateUrl:"app/components/momentFrom/momentFrom.html",scope:{datetime:"="},controller:r,controllerAs:"momentFromCtrl",bindToController:!0};return t}Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,o,n){return o&&t(e.prototype,o),n&&t(e,n),e}}();e.MomentFromDirective=n;var r=function(){function t(e,n,i){"ngInject";var r=this;o(this,t),this.$timeout=e,this.moment=i,this.interval=1e4,this.value="",this.updateTime(),this.updateLater(),n.$on("$destroy",function(){angular.isDefined(r.timeoutId)&&(e.cancel(r.timeoutId),r.timeoutId=void 0)})}return t.$inject=["$timeout","$scope","moment"],i(t,[{key:"updateTime",value:function(){this.value=this.moment(this.datetime).fromNow()}},{key:"updateLater",value:function(){var t=this;this.timeoutId=this.$timeout(function(){t.updateTime(),t.updateLater()},this.interval)}}]),t}()}]),angular.module("intSmaBarcasDashboard").run(["$templateCache",function(t){t.put("app/dashboard/dashboard.html",'<svg version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink x=0px y=0px style="display: none"><symbol id=wave><path d=M420,20c21.5-0.4,38.8-2.5,51.1-4.5c13.4-2.2,26.5-5.2,27.3-5.4C514,6.5,518,4.7,528.5,2.7c7.1-1.3,17.9-2.8,31.5-2.7c0,0,0,0,0,0v20H420z></path><path d=M420,20c-21.5-0.4-38.8-2.5-51.1-4.5c-13.4-2.2-26.5-5.2-27.3-5.4C326,6.5,322,4.7,311.5,2.7C304.3,1.4,293.6-0.1,280,0c0,0,0,0,0,0v20H420z></path><path d=M140,20c21.5-0.4,38.8-2.5,51.1-4.5c13.4-2.2,26.5-5.2,27.3-5.4C234,6.5,238,4.7,248.5,2.7c7.1-1.3,17.9-2.8,31.5-2.7c0,0,0,0,0,0v20H140z></path><path d=M140,20c-21.5-0.4-38.8-2.5-51.1-4.5c-13.4-2.2-26.5-5.2-27.3-5.4C46,6.5,42,4.7,31.5,2.7C24.3,1.4,13.6-0.1,0,0c0,0,0,0,0,0l0,20H140z></path></symbol></svg><md-toolbar class=md-hue-2><div class=md-toolbar-tools><h2><span>Integrada <span hide show-gt-md>- Sistema Mais Água</span></span><br><small>Residencial Barcas</small></h2><span flex></span> <small hide show-gt-xs><span><md-tooltip>{{dashboardCtrl.lastUpdated | momentFormat}}</md-tooltip>Última atualização&nbsp;<moment-from datetime=dashboardCtrl.lastUpdated></moment-from></span></small><md-button aria-label=Sair ng-click=dashboardCtrl.logout()>Sair</md-button></div></md-toolbar><md-content><md-content layout-padding layout-gt-xs=row ng-cloak><section flex-gt-md=25 ng-repeat="block in dashboardCtrl.blocks"><h1>{{block.title}}<md-button ng-disabled=dashboardCtrl.remoteControlWaiting[$index] ng-if="dashboardCtrl.user.is_staff && block.loading === false" ng-click=dashboardCtrl.controlBlock($index)><md-tooltip>{{block.remoteControl ? \'Suspender\' : \'Abastecer\'}} o {{block.title}}</md-tooltip>{{block.remoteControl ? \'Suspender\' : \'Abastecer\'}}</md-button></h1><!-- <p ng-if="!block.inProgress && !block.needWater"> --><p ng-if="!block.needWater && block.loading === false"><md-tooltip>{{block.lastUpdated | momentFormat}}</md-tooltip>Última solicitação:&nbsp;<moment-from datetime=block.lastUpdated></moment-from></p><!-- <p ng-if="!block.inProgress && block.needWater"> --><p ng-if="block.needWater && block.loading === false"><md-tooltip>{{block.needWaterSince | momentFormat}}</md-tooltip>Solicitando:&nbsp;<moment-from datetime=block.needWaterSince></moment-from></p><!-- <p ng-if="block.inProgress">\n      <md-tooltip>\n        {{block.lastUpdated | momentFormat}}\n      </md-tooltip>\n      Abastecendo: {{block.lastUpdated | momentFrom}}\n    </p> --><div class=box ng-if="block.loading === false"><div class=water style="transform: translate(0, {{100 - block.percent}}%)"><svg viewBox="0 0 560 20" class="water_wave water_wave_back"><use xlink:href=#wave></use></svg> <svg viewBox="0 0 560 20" class="water_wave water_wave_front"><use xlink:href=#wave></use></svg></div></div><md-progress-linear md-mode=indeterminate ng-if="(block.inProgress && dashboardCtrl.user.is_staff) || block.loading !== false"></md-progress-linear></section></md-content><md-content layout-padding layout=row ng-cloak><section flex=50><h3>{{dashboardCtrl.cistern.title}}</h3><span><md-tooltip>{{dashboardCtrl.cistern.lastUpdated | momentFormat}}</md-tooltip>{{dashboardCtrl.cistern.upperLevel ? \'Cisterna em nível alto (verificar boia mecânica).\' : (dashboardCtrl.cistern.lowerLevel ? \'Cisterna normal.\' : \'Cisterna em nível baixo (verificar fornecimento de água).\')}}</span></section><section flex=50><h3>{{dashboardCtrl.dryWell.title}}</h3><span><md-tooltip>{{dashboardCtrl.dryWell.lastUpdated | momentFormat}}</md-tooltip>{{dashboardCtrl.dryWell.level ? \'Poço Seco em segurança.\' : \'Risco de inundação.\'}}</span></section></md-content><div hide show-gt-xs flex></div><md-content class=footer layout-padding layout-align="center center"><h5>&copy; 2016 Integrada <small class=md-accent>*Os níveis são apenas ilustrativos.</small></h5></md-content></md-content>'),t.put("app/login/login.html",'<md-content layout=row layout-fill layout-align="center start" ng-cloak><section flex-gt-lg=20 flex-gt-md=30 flex-gt-xs=50 flex=100 class="jumbotron login"><h1><img class=logo ng-src=assets/images/logo.png alt=Integrada></h1><p>Residencial Barcas</p><form name=loginForm ng-submit=loginCtrl.login()><md-input-container class=md-block><label>Usuário</label><input name=username ng-model=loginCtrl.username type=text autofocus required><div ng-messages=loginForm.username.$error><div ng-message=required>Você precisa se identificar.</div></div></md-input-container><md-input-container class=md-block><label>Senha</label><input name=password ng-model=loginCtrl.password type=password required><div ng-messages=loginForm.password.$error><div ng-message=required>Não esqueça sua senha.</div></div></md-input-container><md-button type=submit class="md-raised md-primary pull-right">Entrar</md-button></form></section></md-content>'),t.put("app/components/momentFrom/momentFrom.html","<time datetime={{momentFromCtrl.datetime}}>{{momentFromCtrl.value}}</time>")}]);
//# sourceMappingURL=../maps/scripts/app-028e21412b.js.map
